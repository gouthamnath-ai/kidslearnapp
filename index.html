<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kids Learning Fun</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;800&family=Lexend:wght@400;600;700;800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: "Lexend", "Comic Sans MS", Arial, sans-serif;
  text-align: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #4f0fa3 0%, #6a11cb 40%, #2575fc 100%);
  position: relative;
  overflow-x: hidden;
}

/* Grid overlay */
body::before {
  content: "";
  position: fixed; inset: 0;
  background-image:
    linear-gradient(to right,  rgba(255,255,255,0.1) 1px, transparent 1px),
    linear-gradient(to bottom, rgba(255,255,255,0.1) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}

/* â”€â”€ AUTH â”€â”€ */
.auth-container {
  height: 100vh; display: flex;
  justify-content: center; align-items: center;
  background: linear-gradient(135deg, #667eea, #764ba2);
  position: relative; z-index: 1;
}
.auth-card {
  background: white; padding: 40px; width: 90%; max-width: 400px;
  border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.2);
}
.auth-card h2 {
  margin: 0; color: #6a11cb; font-size: 32px;
  font-family: 'Nunito', sans-serif;
  font-weight: 800; letter-spacing: -0.5px;
}
.auth-card p  { color: #777; font-size: 14px; margin-bottom: 20px; }
.auth-input {
  width: 100%; padding: 14px; margin: 10px 0;
  border-radius: 12px; border: 1px solid #ddd; font-size: 16px;
  font-family: inherit;
}
.auth-btn {
  width: 100%; padding: 14px; margin-top: 12px;
  border-radius: 12px; border: none; background: #6a11cb;
  color: white; font-size: 16px; cursor: pointer; transition: 0.3s;
  font-family: inherit;
}
.auth-btn:hover    { background: #4e0fa3; }
.auth-btn:disabled { opacity: 0.6; cursor: not-allowed; }
.signup       { background: #ff9800; }
.signup:hover { background: #e68900; }
.auth-message         { margin-top: 10px; font-size: 14px; color: red; }
.auth-message.success { color: green; }

/* â”€â”€ GAME SHELL â”€â”€ */
#gameContent {
  display: none;
  position: relative; z-index: 1;
  min-height: 100vh;
}

/* â”€â”€ HEADER (doc3 style) â”€â”€ */
#gameHeader {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 24px;
  max-width: 1100px;
  margin: 0 auto;
}
.header-logo {
  display: flex; align-items: center; gap: 12px;
  background: white;
  padding: 8px 20px 8px 8px;
  border-radius: 9999px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}
.header-logo-icon {
  width: 42px; height: 42px; border-radius: 50%;
  background: rgba(14,165,233,0.15);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px;
}
.header-logo h1 {
  margin: 0; font-size: 20px; font-weight: 800;
  color: #1e293b; font-family: 'Nunito', sans-serif;
}
.header-welcome {
  background: rgba(255,255,255,0.85);
  backdrop-filter: blur(8px);
  padding: 8px 22px; border-radius: 9999px;
  font-size: 15px; font-weight: 700; color: #334155;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border: 1px solid rgba(255,255,255,0.4);
}
#logoutBtn {
  display: flex; align-items: center; gap: 6px;
  background: white; border: none; color: #ef4444;
  padding: 10px 20px; border-radius: 9999px;
  cursor: pointer; font-size: 14px; font-weight: 700;
  box-shadow: 0 4px 14px rgba(0,0,0,0.12);
  transition: background 0.2s;
  font-family: inherit;
}
#logoutBtn:hover { background: #fef2f2; }

/* â”€â”€ REWARD BAR (doc3 style) â”€â”€ */
#rewardBar {
  max-width: 700px; margin: 0 auto 10px;
  background: white; border-radius: 20px;
  padding: 16px 24px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  border: 2px solid rgba(255,255,255,0.6);
  display: flex; justify-content: space-around; flex-wrap: wrap; gap: 8px;
}
.reward-item {
  display: flex; align-items: center; gap: 8px;
  font-size: 16px; font-weight: 700; color: #334155;
}
.reward-trophy { color: #f97316; }
.reward-star   { color: #eab308; }
.reward-candy  { color: #ec4899; }
.reward-count  {
  font-size: 20px; font-weight: 800; color: #135bec;
}

/* â”€â”€ MENU â”€â”€ */
.menu {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 16px; padding: 8px 20px 20px;
  max-width: 560px; margin: 0 auto;
}
.menu-card {
  color: white; padding: 28px 10px; border-radius: 28px;
  cursor: pointer; font-size: 18px; font-weight: 700;
  transition: transform 0.15s, box-shadow 0.15s;
  box-shadow: 0 8px 0 rgba(0,0,0,0.18);
  user-select: none;
  font-family: 'Lexend', sans-serif;
}
.menu-card:hover  { transform: translateY(-5px); box-shadow: 0 12px 0 rgba(0,0,0,0.18); }
.menu-card:active { transform: translateY(3px);  box-shadow: 0 3px 0 rgba(0,0,0,0.18); }
.card-blue  { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
.card-orange{ background: linear-gradient(135deg, #f97316, #c2410c); }
.card-green { background: linear-gradient(135deg, #22c55e, #15803d); }

/* â”€â”€ CONTENT AREA â”€â”€ */
#content {
  background: white; margin: 8px auto 30px;
  padding: 24px; border-radius: 28px; min-height: 360px;
  max-width: 860px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.12);
  border-bottom: 6px solid rgba(0,0,0,0.08);
}

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  padding: 12px 24px; margin: 10px;
  border: none; border-radius: 18px; font-size: 18px; font-weight: 700;
  cursor: pointer; background: #22c55e; color: white;
  box-shadow: 0 4px 0 #15803d; font-family: inherit;
  transition: transform 0.1s;
}
.btn:active { transform: translateY(4px); box-shadow: none; }
.btn.back   { background: #f97316; box-shadow: 0 4px 0 #c2410c; }

/* â”€â”€ KEYS / CARDS â”€â”€ */
.key {
  width: 62px; height: 62px; margin: 6px;
  display: inline-flex; justify-content: center; align-items: center;
  font-weight: 800; color: white; border-radius: 14px;
  cursor: pointer; font-size: 24px;
  box-shadow: 0 4px 0 rgba(0,0,0,0.2);
  transition: transform 0.1s; user-select: none;
}
.key:active { transform: translateY(4px); box-shadow: none; }

/* â”€â”€ COLOR BOX â”€â”€ */
.color-box {
  width: 100px; height: 100px; margin: 8px;
  border-radius: 15px;
  display: inline-flex; justify-content: center; align-items: center;
  font-weight: 700; font-size: 18px; cursor: pointer; color: white;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
  box-shadow: 0 4px 0 rgba(0,0,0,0.2);
  transition: transform 0.1s; user-select: none;
}
.color-box:active { transform: translateY(4px); box-shadow: none; }

/* â”€â”€ BUILT ALPHABET BAR â”€â”€ */
#builtAlphabet {
  min-height: 40px; margin: 15px; padding: 15px;
  border: 3px dashed #fb923c; border-radius: 15px;
  font-size: 28px; font-weight: 800; letter-spacing: 4px;
  color: #ea580c; background: #fff7ed;
  display: flex; flex-wrap: wrap; justify-content: center;
}

/* â”€â”€ EMOJI COUNTING â”€â”€ */
.emoji-display {
  font-size: 40px; letter-spacing: 5px; margin: 20px 0;
  display: flex; flex-wrap: wrap; justify-content: center; gap: 12px;
}

/* â”€â”€ LEVEL BADGE â”€â”€ */
.level-badge {
  display: inline-block;
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  color: white; padding: 6px 22px; border-radius: 9999px;
  font-size: 15px; font-weight: 700; margin-bottom: 12px;
  box-shadow: 0 2px 8px rgba(14,165,233,0.3);
}

/* â”€â”€ CONGRATS â”€â”€ */
.congrats-box {
  background: linear-gradient(135deg, #22c55e, #0ea5e9);
  color: white; padding: 40px; border-radius: 30px; font-size: 24px;
}

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes fall {
  to { transform: translateY(100vh) rotate(360deg); }
}
@keyframes shake {
  0%,100% { transform: translateX(0); }
  25%      { transform: translateX(-6px) rotate(-5deg); }
  50%      { transform: translateX(6px)  rotate(5deg); }
  75%      { transform: translateX(-6px) rotate(-5deg); }
}
@keyframes popIn {
  from { transform: scale(0.8); opacity: 0; }
  to   { transform: scale(1);   opacity: 1; }
}
.shake {
  animation: shake 0.4s ease-in-out;
  background: #f44336 !important;
  box-shadow: 0 4px 0 #b71c1c !important;
}
.pop-in { animation: popIn 0.3s ease; }
</style>
</head>
<body>

<!-- â•â•â• LOGIN PAGE â•â•â• -->
<div id="loginPage" class="auth-container">

  <!-- LOGIN CARD -->
  <div class="auth-card" id="loginCard">
    <h2>Kids Learning</h2>
    <p>Login to start learning</p>
    <input type="email"    id="email"    placeholder="Email Address" class="auth-input">
    <input type="password" id="password" placeholder="Password"      class="auth-input">
    <button class="auth-btn" id="loginBtn">Login</button>
    <button class="auth-btn signup" id="showSignupBtn">Create Account</button>
    <p id="authMessage" class="auth-message"></p>
  </div>

  <!-- SIGNUP CARD -->
  <div class="auth-card" id="signupCard" style="display:none;">
    <h2>Create Account</h2>
    <p>Join Kids Learning today!</p>
    <input type="email"    id="signupEmail"    placeholder="Email Address"     class="auth-input">
    <input type="password" id="signupPassword" placeholder="Password"          class="auth-input">
    <input type="password" id="confirmPassword" placeholder="Confirm Password" class="auth-input">
    <button class="auth-btn signup" id="signupBtn">Create Account</button>
    <button class="auth-btn" id="backToLoginBtn" style="background:#888;margin-top:8px;">â¬… Back to Login</button>
    <p id="signupMessage" class="auth-message"></p>
  </div>

</div>

<!-- â•â•â• GAME PAGE â•â•â• -->
<div id="gameContent">

  <!-- Header -->
  <div id="gameHeader">
    <div class="header-logo">
      <div class="header-logo-icon">ğŸ“š</div>
      <h1>Kids Learning</h1>
    </div>
    <div class="header-welcome">
      <span id="welcomeMsg">Welcome!</span>
    </div>
    <button id="logoutBtn">â‡¦ Log Out</button>
  </div>

  <!-- Reward Bar -->
  <div id="rewardBar">
    <div class="reward-item">
      <span class="reward-trophy">ğŸ†</span>
      <span>Trophies</span>
      <span class="reward-count" id="trophies">0</span>
    </div>
    <div class="reward-item">
      <span class="reward-star">â­</span>
      <span>Stars</span>
      <span class="reward-count" id="stars">0</span>
    </div>
    <div class="reward-item">
      <span class="reward-candy">ğŸ¬</span>
      <span>Candies</span>
      <span class="reward-count" id="candies">0</span>
    </div>
  </div>

  <!-- Subject Menu -->
  <section class="menu">
    <div class="menu-card card-blue"   id="btnABC">ğŸ”¤<br>Alphabets</div>
    <div class="menu-card card-orange" id="btnNUM">ğŸ”¢<br>Numbers</div>
    <div class="menu-card card-green"  id="btnCOL">ğŸ¨<br>Colors</div>
  </section>

  <!-- Content Area -->
  <section id="content">
    <div style="
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      min-height: 360px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    ">
      <!-- Background image -->
      <div style="
        position: absolute; inset: 0;
        background-image: url('https://images.unsplash.com/photo-1509062522246-3755977927d7?w=1600&auto=format&fit=crop&q=100');
        background-size: cover;
        background-position: center top;
        border-radius: 20px;
      "></div>
      <!-- Gradient overlay -->
      <div style="
        position: absolute; inset: 0;
        background: linear-gradient(to bottom, rgba(10,30,60,0.45) 0%, rgba(10,30,60,0.72) 100%);
        border-radius: 20px;
      "></div>
      <!-- Content -->
      <div style="position: relative; z-index: 1; padding: 50px 30px;">
        <h2 style="color: white; font-family: Lexend, sans-serif; font-size: 30px; font-weight: 800;
          text-shadow: 0 3px 16px rgba(0,0,0,0.7); margin: 0 0 14px; line-height: 1.3;">
          Pick a subject above to start learning!
        </h2>
        <p style="color: rgba(255,255,255,0.85); font-size: 17px; margin: 0;
          text-shadow: 0 1px 8px rgba(0,0,0,0.6); letter-spacing: 0.5px;">
          ğŸ”¤ Alphabets &nbsp;â€¢&nbsp; ğŸ”¢ Numbers &nbsp;â€¢&nbsp; ğŸ¨ Colors
        </p>
      </div>
    </div>
  </section>

</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const COLORS      = ["#f44336","#ff9800","#ffeb3b","#4caf50","#2196f3","#9c27b0","#00bcd4","#e91e63"];
const COLOR_NAMES = ["Red","Orange","Yellow","Green","Blue","Purple","Cyan","Pink"];
const COUNT_EMOJIS = ["ğŸ","ğŸ¶","ğŸš—","ğŸˆ","ğŸ§¸","ğŸ¦","âš½","ğŸ¦‹","â­","ğŸ“"];

const ABC_LEVEL_RANGES = [
  { start:65, end:70, label:"A to F" },
  { start:71, end:77, label:"G to M" },
  { start:78, end:83, label:"N to S" },
  { start:84, end:90, label:"T to Z" },
  { start:65, end:90, label:"A to Z" }
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function randColor(i) { return COLORS[i % COLORS.length]; }

function speak(text) {
  if (!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.rate = 0.85; u.pitch = 1.1;
  window.speechSynthesis.speak(u);
}

const wrongAudio = new Audio("https://actions.google.com/sounds/v1/cartoon/slip_bobble.ogg");
function playWrong() { wrongAudio.currentTime = 0; wrongAudio.play().catch(()=>{}); }

function shakeEl(el) {
  if (!el) return;
  el.classList.add("shake");
  setTimeout(() => el.classList.remove("shake"), 420);
}

function confetti() {
  const pieces = ["ğŸŠ","â­","ğŸ‰","ğŸ¬","ğŸ†"];
  for (let i = 0; i < 30; i++) {
    setTimeout(() => {
      const c = document.createElement("div");
      c.textContent = pieces[Math.floor(Math.random() * pieces.length)];
      c.style.cssText = `position:fixed;left:${Math.random()*100}%;top:-20px;
        font-size:30px;animation:fall 2.5s linear;z-index:9999;pointer-events:none;`;
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 2500);
    }, i * 90);
  }
}

const content = document.getElementById("content");
function setContent(html) { content.innerHTML = html; }
function home() {
  setContent(`
    <div style="
      position: relative; border-radius: 20px; overflow: hidden;
      min-height: 320px; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
    ">
      <div style="
        position: absolute; inset: 0;
        background-image: url('https://images.unsplash.com/photo-1509062522246-3755977927d7?w=1600&auto=format&fit=crop&q=100');
        background-size: cover; background-position: center top;
        border-radius: 20px;
      "></div>
      <div style="
        position: absolute; inset: 0;
        background: linear-gradient(to bottom, rgba(10,30,60,0.45) 0%, rgba(10,30,60,0.72) 100%);
        border-radius: 20px;
      "></div>
      <div style="position: relative; z-index: 1; padding: 50px 30px;">
        <h2 style="color: white; font-family: Lexend, sans-serif; font-size: 30px; font-weight: 800;
          text-shadow: 0 3px 16px rgba(0,0,0,0.7); margin: 0 0 14px; line-height: 1.3;">
          Pick a subject above to start learning!
        </h2>
        <p style="color: rgba(255,255,255,0.85); font-size: 17px; margin: 0;
          text-shadow: 0 1px 8px rgba(0,0,0,0.6); letter-spacing: 0.5px;">
          ğŸ”¤ Alphabets &nbsp;â€¢&nbsp; ğŸ”¢ Numbers &nbsp;â€¢&nbsp; ğŸ¨ Colors
        </p>
      </div>
    </div>
  `);
}

function showCongrats(type) {
  const msgs = {
    trophies: "ğŸ† All Alphabet Levels Done!",
    stars:    "â­ All Number Levels Done!",
    candies:  "ğŸ¬ All Color Levels Done!"
  };
  speak("Congratulations! You completed all levels!");
  confetti();
  setContent(`<div class="congrats-box pop-in">
    <div style="font-size:60px;">ğŸ‰</div>
    <h2>${msgs[type]}</h2>
    <p style="font-size:20px;">You're a superstar learner!</p>
    <button class="btn" onclick="home()">ğŸ  Go Home</button>
  </div>`);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REWARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let rewards = { trophies: 0, stars: 0, candies: 0 };

function updateRewardsDisplay() {
  document.getElementById("trophies").textContent = rewards.trophies;
  document.getElementById("stars").textContent    = rewards.stars;
  document.getElementById("candies").textContent  = rewards.candies;
}

function addReward(type) {
  rewards[type]++;
  updateRewardsDisplay();
  confetti();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ALPHABETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let abcLevel = 1, expectedLetter = 65, currentLevelEnd = 90;

function learnABC() {
  let keys = "";
  for (let i = 65; i <= 90; i++) {
    const l = String.fromCharCode(i);
    keys += `<div class="key" style="background:${randColor(i)}" onclick="speak('${l}')">${l}</div>`;
  }
  setContent(`
    <h2 style="color:#1565c0;">ğŸ”¤ Learn the Alphabets!</h2>
    <p style="color:#555;">Tap any letter to hear it spoken!</p>
    <div style="margin:10px 0;">${keys}</div>
    <br>
    <button class="btn" onclick="startABC()">â–¶ Start Quiz!</button>
    <button class="btn back" onclick="home()">â¬… Back</button>
  `);
}

function startABC() {
  abcLevel = 1;
  startABCLevel();
}

function startABCLevel() {
  if (abcLevel > 5) { showCongrats("trophies"); return; }

  const range = ABC_LEVEL_RANGES[abcLevel - 1];
  expectedLetter = range.start;
  currentLevelEnd = range.end;

  const letters = [];
  for (let i = range.start; i <= range.end; i++) letters.push(String.fromCharCode(i));
  letters.sort(() => Math.random() - 0.5);

  let keyHTML = letters.map((l, i) =>
    `<div class="key" id="key-${l}" style="background:${randColor(i)}" onclick="checkABC('${l}', this)">${l}</div>`
  ).join("");

  setContent(`
    <h2 style="color:#1565c0;">ğŸ”¤ Alphabet Quiz</h2>
    <div class="level-badge">Level ${abcLevel} / 5 â€” ${range.label}</div>
    <h3 style="color:#555;">Tap the letters <u>in order</u>!</h3>
    <div id="builtAlphabet"></div>
    <div id="orderContainer" style="margin-top:10px;">${keyHTML}</div>
  `);
  speak("Tap the letters in order from " + range.label);
}

function checkABC(letter, btn) {
  if (letter.charCodeAt(0) === expectedLetter) {
    speak(letter);
    document.getElementById(`key-${letter}`).style.visibility = "hidden";
    document.getElementById("builtAlphabet").innerHTML += `<span>${letter} </span>`;
    expectedLetter++;
    if (expectedLetter > currentLevelEnd) {
      addReward("trophies");
      abcLevel++;
      setTimeout(startABCLevel, 1400);
    }
  } else {
    playWrong();
    shakeEl(btn);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NUMBERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let numLevel = 1, numCorrect = 0, numAnswer = 0;

function learnNUM() {
  let keys = "";
  for (let i = 1; i <= 15; i++) {
    keys += `<div class="key" style="background:${randColor(i)}" onclick="speak('${i}')">${i}</div>`;
  }
  setContent(`
    <h2 style="color:#bf360c;">ğŸ”¢ Learn Numbers!</h2>
    <p style="color:#555;">Tap any number to hear it!</p>
    <div style="margin:10px 0;">${keys}</div>
    <br>
    <button class="btn" onclick="startNUM()">â–¶ Start Quiz!</button>
    <button class="btn back" onclick="home()">â¬… Back</button>
  `);
}

function startNUM() {
  numLevel = 1;
  numCorrect = 0;
  nextNUM();
}

function nextNUM() {
  if (numLevel > 5) { showCongrats("stars"); return; }

  let minNum, maxNum, optionCount;
  if      (numLevel === 1) { minNum = 1;  maxNum = 3;  optionCount = 3; }
  else if (numLevel === 2) { minNum = 4;  maxNum = 6;  optionCount = 4; }
  else if (numLevel === 3) { minNum = 7;  maxNum = 9;  optionCount = 5; }
  else if (numLevel === 4) { minNum = 10; maxNum = 12; optionCount = 6; }
  else                     { minNum = 13; maxNum = 15; optionCount = 8; }

  numAnswer = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;
  const emoji = COUNT_EMOJIS[Math.floor(Math.random() * COUNT_EMOJIS.length)];
  const emojisHTML = emoji.repeat(numAnswer);

  speak("How many are there?");

  let options = [numAnswer];
  while (options.length < optionCount) {
    const fake = Math.floor(Math.random() * 15) + 1;
    if (!options.includes(fake)) options.push(fake);
  }
  options.sort(() => Math.random() - 0.5);

  const optHTML = options.map((o, i) =>
    `<div class="key" style="background:${randColor(i)};width:70px;height:70px;font-size:26px;"
      onclick="checkNUM(${o}, this)">${o}</div>`
  ).join("");

  setContent(`
    <h2 style="color:#bf360c;">ğŸ”¢ Count the Emojis!</h2>
    <div class="level-badge">Level ${numLevel} / 5</div>
    <div class="emoji-display">${emojisHTML}</div>
    <p style="color:#555;font-size:18px;font-weight:bold;">How many ${emoji} do you see?</p>
    <div id="numOptions" style="margin-top:10px;">${optHTML}</div>
    <div id="numFeedback" style="font-size:22px;margin-top:12px;font-weight:bold;"></div>
  `);
}

function checkNUM(val, btn) {
  if (val === numAnswer) {
    document.getElementById("numFeedback").textContent = "ğŸ‰ Correct! " + val + " it is!";
    speak(val + "! Awesome!");
    addReward("stars");
    numCorrect++;
    if (numCorrect >= 2) { numLevel++; numCorrect = 0; }
    setTimeout(nextNUM, 1500);
  } else {
    playWrong();
    shakeEl(btn);
    numCorrect = 0;
    document.getElementById("numFeedback").textContent = "ğŸ˜Š Try again!";
    setTimeout(() => {
      const el = document.getElementById("numFeedback");
      if (el) el.textContent = "";
    }, 800);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COLORS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let colorLevel = 1, colorSequence = [], colorStep = 0;

function learnCOLOR() {
  const swatches = COLORS.map((c, i) =>
    `<div class="color-box" style="background:${c}" onclick="speak('${COLOR_NAMES[i]}')">${COLOR_NAMES[i]}</div>`
  ).join("");
  setContent(`
    <h2 style="color:#2e7d32;">ğŸ¨ Learn Colors!</h2>
    <p style="color:#555;">Tap a color to hear its name!</p>
    <div style="margin:10px 0;">${swatches}</div>
    <br>
    <button class="btn" onclick="startCOLOR()">â–¶ Start Quiz!</button>
    <button class="btn back" onclick="home()">â¬… Back</button>
  `);
}

function startCOLOR() {
  colorLevel = 1;
  nextCOLOR();
}

function nextCOLOR() {
  if (colorLevel > 5) { showCongrats("candies"); return; }

  colorStep = 0;
  colorSequence = [];

  const available = [0,1,2,3,4,5,6,7].sort(() => Math.random() - 0.5);
  for (let i = 0; i < colorLevel; i++) colorSequence.push(available[i]);

  const targetLabel = colorSequence.map(idx => COLOR_NAMES[idx]).join(" â” ");
  speak("Find " + colorSequence.map(idx => COLOR_NAMES[idx]).join(", then "));

  const options = [0,1,2,3,4,5,6,7].sort(() => Math.random() - 0.5);
  const swatchHTML = options.map(o =>
    `<div class="color-box" id="cswatch-${o}" style="background:${COLORS[o]}"
      onclick="checkCOLOR(${o}, this)"></div>`
  ).join("");

  setContent(`
    <h2 style="color:#2e7d32;">ğŸ¨ Color Quiz!</h2>
    <div class="level-badge">Level ${colorLevel} / 5</div>
    <h3 style="color:#555;">Tap colors in order:</h3>
    <p style="font-size:20px;font-weight:bold;color:#ff5722;">${targetLabel}</p>
    <div id="colorOptions" style="margin-top:10px;">${swatchHTML}</div>
    <div id="colorFeedback" style="font-size:22px;margin-top:12px;font-weight:bold;"></div>
  `);
}

function checkCOLOR(val, btn) {
  if (val === colorSequence[colorStep]) {
    speak(COLOR_NAMES[val]);
    btn.style.opacity = "0.3";
    btn.style.pointerEvents = "none";
    colorStep++;
    document.getElementById("colorFeedback").textContent = "âœ… " + COLOR_NAMES[val] + "!";
    if (colorStep >= colorSequence.length) {
      addReward("candies");
      colorLevel++;
      setTimeout(nextCOLOR, 1400);
    }
  } else {
    playWrong();
    shakeEl(btn);
    document.getElementById("colorFeedback").textContent = "ğŸ˜Š Try again!";
    setTimeout(() => {
      const el = document.getElementById("colorFeedback");
      if (el) el.textContent = "";
    }, 800);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SUPABASE AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var SUPABASE_URL = "";
var SUPABASE_KEY = "";
var sb = null;

document.getElementById("btnABC").addEventListener("click", learnABC);
document.getElementById("btnNUM").addEventListener("click", learnNUM);
document.getElementById("btnCOL").addEventListener("click", learnCOLOR);
document.getElementById("loginBtn").addEventListener("click", doSignIn);
document.getElementById("signupBtn").addEventListener("click", doSignUp);
document.getElementById("logoutBtn").addEventListener("click", doLogout);

// Switch between login and signup cards
document.getElementById("showSignupBtn").addEventListener("click", function() {
  document.getElementById("loginCard").style.display  = "none";
  document.getElementById("signupCard").style.display = "block";
  document.getElementById("authMessage").innerText    = "";
});
document.getElementById("backToLoginBtn").addEventListener("click", function() {
  document.getElementById("signupCard").style.display = "none";
  document.getElementById("loginCard").style.display  = "block";
  document.getElementById("signupMessage").innerText  = "";
});

try {
  sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  sb.auth.getSession().then(function(res) {
    if (res.data && res.data.session) launchGame(res.data.session.user.email);
  });
} catch(e) {
  showAuthMessage("âš ï¸ Supabase config missing. Set your URL and Key.");
}

function showAuthMessage(msg, success) {
  const el = document.getElementById("authMessage");
  el.innerText = msg;
  el.className = "auth-message" + (success ? " success" : "");
}

function showSignupMessage(msg, success) {
  const el = document.getElementById("signupMessage");
  el.innerText = msg;
  el.className = "auth-message" + (success ? " success" : "");
}

function setLoading(on) {
  document.getElementById("loginBtn").disabled    = on;
  document.getElementById("loginBtn").textContent = on ? "Please wait..." : "Login";
}

function setSignupLoading(on) {
  document.getElementById("signupBtn").disabled    = on;
  document.getElementById("signupBtn").textContent = on ? "Please wait..." : "Create Account";
}

function launchGame(email) {
  document.getElementById("welcomeMsg").textContent    = "Hello, " + email.split("@")[0] + "! ğŸ‘‹";
  document.getElementById("loginPage").style.display   = "none";
  document.getElementById("gameContent").style.display = "block";
  updateRewardsDisplay();
  speak("Welcome! Let's start learning!");
}

async function doSignUp() {
  if (!sb) { showSignupMessage("âš ï¸ Supabase not configured."); return; }
  const email   = document.getElementById("signupEmail").value.trim();
  const pass    = document.getElementById("signupPassword").value;
  const confirm = document.getElementById("confirmPassword").value;
  if (!email || !pass) { showSignupMessage("Please enter email and password."); return; }
  if (pass.length < 6) { showSignupMessage("Password must be at least 6 characters."); return; }
  if (pass !== confirm) { showSignupMessage("Passwords do not match. Please try again."); return; }
  setSignupLoading(true);
  showSignupMessage("Creating account...", true);
  const r = await sb.auth.signUp({ email, password: pass });
  if (r.error) { showSignupMessage(r.error.message); setSignupLoading(false); return; }
  if (r.data && r.data.session) { launchGame(r.data.user.email); setSignupLoading(false); return; }
  const r2 = await sb.auth.signInWithPassword({ email, password: pass });
  setSignupLoading(false);
  if (r2.error) showSignupMessage("Account created! Check email to confirm, then log in.", true);
  else          launchGame(r2.data.user.email);
}

async function doSignIn() {
  if (!sb) { showAuthMessage("âš ï¸ Supabase not configured."); return; }
  const email = document.getElementById("email").value.trim();
  const pass  = document.getElementById("password").value;
  if (!email || !pass) { showAuthMessage("Please enter email and password."); return; }
  setLoading(true);
  showAuthMessage("Logging in...", true);
  const r = await sb.auth.signInWithPassword({ email, password: pass });
  setLoading(false);
  if (r.error) showAuthMessage(r.error.message);
  else         launchGame(r.data.user.email);
}

async function doLogout() {
  if (sb) await sb.auth.signOut();
  location.reload();
}
</script>
</body>
</html>

